<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="https://glitch.com/favicon.ico" />

    <title>Listening for Loaded Async Scripts</title>
  </head>
  <body>
    <h1>Listening for Loaded Async Scripts</h1>

    <p>
      This demonstrates a few ways that a blocking non-<code>async</code> script
      can listen for an <code>async</code> script to load:
    </p>
    <ol>
      <li>
        An <code>onload</code> event handler attribute on the
        <code>script[async]</code>.
      </li>
      <li>
        Adding a <code>load</code> event listener to the
        <code>script[async]</code> which has a defined <code>id</code>.
      </li>
      <li>
        Listening for the <code>readystatechange</code> event until
        <code>document.readyState === 'complete'</code>. The downside here is it
        waits for <em>all</em> async scripts and other assets to have downloaded
        (so similar to the <code>load</code> event on <code>window</code>).
      </li>
      <li>
        The <code>load</code> event on the window. (Worse than
        <code>readystatechange</code>.)
      </li>
      <li>Polling with <code>setInterval</code> (the worst).</li>
    </ol>
    
    <hr>

    <pre id="output"></pre>

    <script id="async-js-before">
      document.getElementById("output").textContent +=
        "Inline blocking before script evaluated\n";
      window.myAsyncLib = window.myAsyncLib || [];
      window.myAsyncLib.push((lib) => {
        lib.log("async library event system");
      });
    </script>
    <script
      src="/script.js"
      async
      id="async-js"
      onload="/*OPTION 1*/ window.myAsyncLib.push((lib) => {lib.log('script onload attribute')})"
    ></script>
    <script id="async-js-after">
      document.getElementById("output").textContent +=
        "Inline blocking after script evaluated\n";

      // TODO: Confirm that the async script will NEVER be fully loaded before this script is executed.
      document.getElementById("async-js").addEventListener("load", () => {
        /*OPTION 2*/
        document.getElementById("output").textContent +=
          "Async script load event triggered\n";
        window.myAsyncLib.push((lib) => {
          lib.log("script load event handler");
        });
      });

      document.addEventListener("readystatechange", (event) => {
        document.getElementById(
          "output"
        ).textContent += `Ready state change: ${document.readyState}\n`;
        if (document.readyState === "complete") {
          /*OPTION 3*/
          window.myAsyncLib.push((lib) => {
            lib.log("readystatechange event handler");
          });
        }
      });

      window.addEventListener("load", () => {
        /*OPTION 4*/
        window.myAsyncLib.push((lib) => {
          lib.log("window load event handler");
        });
      });

      const interval = setInterval(() => {
        if (window.myAsyncLib) {
          clearInterval(interval);
          window.myAsyncLib.push((lib) => {
            lib.log("setInterval polling");
          });
        }
      }, 10);
    </script>

    <hr />
    <address>
      <a href="https://weston.ruter.net/">@westonruter</a>
    </address>
  </body>
</html>
